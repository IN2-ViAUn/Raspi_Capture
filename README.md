# Raspi_Capture
以上文件位于树莓派的`~/ros2_ws`文件夹，主要代码位于：`src/two_camera/src/appsink1~3.cpp`以及`src/sub_synch/src/time_synch.cpp`中，ReadMe文档将从代码逻辑、执行方式以及如何在新的树莓派上部署代码展开。另外，服务端代码在最后给出并解释。
## 实现功能及代码逻辑
图采系统包括采集、同步、传输三部分，其中树莓派采集三个摄像头图像并做ros2时间戳同步，服务端发出指令：`capture N/save/shutdown`，三条指令分别对应：树莓派采集并保存N张同步且拼接后的图像到树莓派本地/将保存到本地的图片传输到服务器中/结束连接。
### appsink1~3
  当树莓派接收到capture N（N为正整数）指令时，在代码中会自动执行命令：ros2 run two_camera appsink1/2/3，这三个cpp文件分别对应三个摄像头，作用是发布三个摄像头的ros2节点信息，并带有时间戳方便同步。
### time_synch
  树莓派主要代码，作用是查询服务器有没有发出指令，以及在接收到指令之后执行对应操作。当图采系统处于准备状态时，场地上的所有树莓派一直在执行这段代码，并且执行shutdown断开与服务器的连接后也不会结束进程。
  - **接收到“capture N”后：**
  
    启动订阅节点订阅三个摄像头的图像，并做同步。每当成功同步一次就执行触发函数`void syncCallback()`，2*2拼接三张图像（右下角为纯黑图像），保存拼接后的图像并以“端口号_三张图象的平均ros2时间戳.jpg”命名。此时的树莓派日志会看到有`"[1]ROS 2 Time: %ld.%09ld\n", seconds, nanoseconds`的日志滚动，表明摄像头打开并发布消息。如果不想要日志滚动，在`appsink1~3.cpp`中注释掉对应的代码即可。
  - **接收到“save”后：**

    按照之前保存的路径，遍历其中所有的图片并依次发送到服务器，先发送文件名长度和文件名，再编码并发送图片。
  - **接收到“shutdown”后：**

    断开与服务器的连接，并删除保存在树莓派本地的图片，并关闭摄像头。关闭摄像头的实现是通过命令`fuser -k /dev/video0`查询并杀死对应摄像头的进程。此时可以看到之前滚动的日志结束了，表明摄像头关闭，这样可以避免摄像头持续打开，避免摄像头因为发热折寿[doge]。
## 部署方法
- **前期准备：** 有一个已经烧录`ubuntu-22.04-preinstalled-desktop-arm64+raspi.img`的SD卡+树莓派4b，安装ros2、时间设置、SSH开启等，参考这一篇博客（我写的）：https://blog.csdn.net/weixin_61967846/article/details/139688989?spm=1001.2014.3001.5501
- **代码部署：**
  ```
    # 新建文件夹，-p为-parent意思，如果该路径下有父目录不存在，则一并创建父目录
    mkdir -p ~/ros2_ws/src
    cd ~/ros2_ws/src
  ```








